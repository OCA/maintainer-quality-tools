#!/bin/bash
#
# USAGE
# travis_run_tests.sh

database=openerp_test

# For backward compatibility, take version from parameter if it's not globally set
if [ "x${VERSION}" == "x" ] ; then
    VERSION="${1}"
    echo "WARNING: no env variable set for VERSION. Using '${1}'."
fi

case ${VERSION} in 
    6.1)
        options=""
        install_options="--test-disable"
        ;;
    *)
        options="--test-enable"
        install_options=""
        ;;
esac

: ${ODOO_REPO:="odoo/odoo"}  # default value, if not set
IFS="/" read -a REPO <<< "$ODOO_REPO"

server_path="../${REPO[1]}-${VERSION}"
addons_path="`get-addons ${TRAVIS_BUILD_DIR} ${HOME} ${server_path}/addons`"

if [ -z "${EXCLUDE}" ] ; then
    tested_addons="`get-addons -m ${TRAVIS_BUILD_DIR}`"
else
    tested_addons="`get-addons -m -e ${EXCLUDE} ${TRAVIS_BUILD_DIR}`"
fi

echo "Working in ${TRAVIS_BUILD_DIR}"
ls ${TRAVIS_BUILD_DIR}
echo "Using repo ${ODOO_REP} and addons path ${addons_path}"
echo "Modules to test: ${tested_addons}"


# setup the base module without running the tests
echo
echo "Setting up the database"
createdb ${database}
$server_path/openerp-server -d ${database} --addons-path=${addons_path} ${install_options} --stop-after-init -i ${tested_addons}

command="$server_path/openerp-server -d ${database} ${options} \
--stop-after-init  --log-level test \
--addons-path=${addons_path} \
-i ${tested_addons}"

echo "Server initialization command:"
echo "${command}"

case ${VERSION} in 
    5.0|6.0|6.1|7.0)
        coverage run $command | tee stdout.log
        RES=$?

        if $(grep -v mail stdout.log | egrep -q "(At least one test failed when loading the modules.|ERROR ${database})")
        then
            exit 1
        else
            exit $RES
        fi
        ;;
    *)
        coverage run $command
        exit $?
        ;;
esac
