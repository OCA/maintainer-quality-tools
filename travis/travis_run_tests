#!/bin/bash

#
# USAGE
# travis_run_tests.sh VERSION MODULE_NAME [dependency_repo_1...]

version=$1
module_name=$2
shift 2

case ${version} in 
    7.0)
        options="--test-enable"
        install_options=""
        ;;
    6.1)
        options=""
        install_options="--test-disable"
        ;;
    *)
        options=""
        install_options=""
        ;;
esac

addons_path=/usr/share/pyshared/openerp/addons

for repo in "$@" $TRAVIS_BUILD_DIR; 
do
    addons_path=${repo},${addons_path}
done

psql -c 'create database ${module_name} with owner openerp;' -U postgres
# setup the base module without running the tests
echo
echo setting up the database
/usr/bin/openerp-server --db_user=openerp --db_password=admin -d ${module_name} --addons-path=${addons_path} ${install_options} --stop-after-init -i base

command="/usr/bin/openerp-server --db_user=openerp --db_password=admin -d ${module_name} ${options} \
--stop-after-init  --log-level test \
--addons-path=${addons_path} \
-i ${module_name}"

echo
echo ${command}
coverage run $command | tee stdout.log

if $(grep -v mail stdout.log | grep -q "At least one test failed when loading the modules.")
then
    exit 1
else
    exit 0
fi

